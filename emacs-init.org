#+TITLE: Emacs Init
#+AUTHOR: Jonathan Lai

* Emacs Init as an Org file

** My Emacs setup
Lets make this organized and documented org-mode style

** init-basics
Here lets do the preliminary setup and put in some good defaults for emacs, including setting some system wide variables.

#+BEGIN_SRC emacs-lisp

(require 'package)
(setq package-archives '(("melpa" . "https://melpa.org/packages/")
                         ("gnu" . "http://elpa.gnu.org/packages/")
                         ;; ("org" . "http://orgmode.org/elpa/")
                         ;; uncomment the below line if an elpa is down (e.g. melpa.org)
                         ;; it will install elpa packages from the "backup-elpa", the local backup
                         ;; ("backup-elpa" . "~/.emacs.d/.backup-elpa/")
))
(eval-when-compile (package-initialize))

(if (not (package-installed-p 'use-package))
  (progn
    (package-refresh-contents)
    (package-install 'use-package)))

(require 'use-package)
(setq use-package-always-ensure t)

(let ((default-directory "~/.emacs.d/custom/"))
  (normal-top-level-add-to-load-path '("."))
  (normal-top-level-add-subdirs-to-load-path))

(require 'dired-x)
(require 'cross-platform-copy-paste)

(defcustom dotemacs-cache-directory (concat user-emacs-directory ".cache/")
  "The storage location for various persistent files.")

;; Backup Files location
;; https://github.com/bling/dotemacs/blob/master/config/init-core.el
(setq backup-directory-alist
      `((".*" . ,(concat dotemacs-cache-directory "backups")))
      auto-save-file-name-transforms
      `((".*" ,(concat dotemacs-cache-directory "backups") t))
      auto-save-list-file-prefix
      (concat dotemacs-cache-directory "auto-save-list/saves-"))

(use-package esup)

(use-package f
  :config
  (progn
    (unless (f-exists? dotemacs-cache-directory)
      (f-mkdir dotemacs-cache-directory))))

;; https://github.com/kiwanami/emacs-deferred
(use-package deferred)

;; SPU - Emacs Silent Package Upgrader
(use-package spu)

;; https://github.com/redguardtoo/elpa-mirror
;; For if/when melpa goes down, prepare for a backup
;; Use `M-x elpamr-create-mirror-for-installed` to create a local repository.
(use-package elpa-mirror
  :config
  (progn
    (setq dotemacs-backup-elpa-directory (concat user-emacs-directory ".backup-elpa/"))
    (setq elpamr-default-output-directory dotemacs-backup-elpa-directory)
    (unless (f-exists? dotemacs-backup-elpa-directory)
      (f-mkdir dotemacs-backup-elpa-directory))))

(use-package undo-tree
  :config
  (progn
    (global-undo-tree-mode t)))

;; Dont display logo at startup
(setq inhibit-startup-message t)

;; How do I change the scratch message in Emacs?
;; http://stackoverflow.com/a/1498292/2741455
(setq initial-scratch-message ";; This is the Emacs Scratch Buffer")

(defalias 'yes-or-no-p 'y-or-n-p)

;; Don't automatically add newline to end of file
(setq mode-require-final-newline nil)

(setq recentf-save-file (concat dotemacs-cache-directory "recentf"))
(if (not (f-exists? recentf-save-file))
  (progn
    (f-touch recentf-save-file)
    (use-package s) ;; this should already be installed -- f.el has this as a dependency
    (setq spacer-readme (s-concat (f-full user-emacs-directory) "README.md" )) ;; => /home/path/to/file
    (setq spacer-recentf (s-concat "(setq recentf-list '(\"" spacer-readme "\")) (setq recentf-filter-changer-current 'nil)"))
    (f-write spacer-recentf 'utf-8 recentf-save-file)))
(setq recentf-max-menu-items 10)
(setq recentf-auto-cleanup 'never)
(recentf-mode 1)

(setq-default tab-width 2)
(setq-default indent-tabs-mode nil) ;; seems to affect autocomplete modes

(setq visible-bell 1)
(menu-bar-mode -1)

;; recentf hook for when a file is not opened, but just a scratch buffer, then load recentf
(defun recentf-open-files-hook ()
  ;;(if (not (f-this-file))
  ;;  (recentf-open-files))
  (if (eq (buffer-file-name) nil)
    (recentf-open-files)))

(add-hook 'emacs-startup-hook 'recentf-open-files-hook)

;; From http://www.emacswiki.org/RecentFiles
(defun recentf-ido-find-file ()
  "Find a recent file using Ido."
  (interactive)
  (let ((file (ido-completing-read "Choose recent file: " recentf-list nil t)))
    (when file
      (find-file file))))

;; Closing all other buffers in Emacs
;; http://stackoverflow.com/a/3417473/2741455
(defun kill-other-buffers ()
  "Kill all other buffers."
  (interactive)
  (mapc 'kill-buffer
    (delq (current-buffer)
      (remove-if-not 'buffer-file-name (buffer-list)))))

#+END_SRC

** init-aesthetics
Lets make emacs look and behave better.

#+BEGIN_SRC emacs-lisp
(line-number-mode t)
(column-number-mode t)
(global-linum-mode t)

(use-package smartparens
  :config
  (progn
    (require 'smartparens-config)
    (smartparens-global-mode 1)))

(use-package evil-search-highlight-persist
  :config
  (progn
    (global-evil-search-highlight-persist t)))

(use-package whitespace
  :config
  (progn
    (setq whitespace-style (quote (spaces tabs newline space-mark tab-mark newline-mark)))
    (setq whitespace-display-mappings
      '((space-mark 32 [183] [46])
        (tab-mark 9 [9655 9] [92 9])))))

(use-package ethan-wspace)

;;(use-package apropospriate-theme
;;  :defer t
;;  :config (load-theme 'apropospriate-dark t)) ;; issues with this one, but nice for html-mode

;; not quite sure how to set this theme up
(setq max-lisp-eval-depth 10000)

(use-package apropospriate-theme)
;;(load-theme 'apropospriate-dark t) ;; issues with this one, but nice for html-mode

;;(use-package zenburn-theme)
(use-package zenburn-theme
  :defer t
  :config
  (progn (load-theme 'zenburn t)))

;; (use-package monokai-theme)
(use-package monokai-theme
  :defer t
  :config
  (progn (load-theme 'monokai t)))

;; (use-package material-theme)
(use-package material-theme
  :defer t
  :config
  (progn (load-theme 'material t)))

;;(use-package spacemacs-theme)
(use-package spacemacs-theme
  :defer t
  :config
  (progn
    (load-theme 'spacemacs-dark t)))

(use-package moe-theme
  :defer t
  :config
  (load-theme 'moe-dark t))

;;(use-package solarized-theme)
(use-package solarized-theme
  :defer t
  :config
  (progn (load-theme 'solarized-dark t)))

(use-package theme-changer
  :init
  (setq calendar-location-name "New York, NY"
           calendar-latitude 41.8
           calendar-longitude -73.59)
  :config
  (change-theme 'solarized-dark 'apropospriate-dark))

(use-package display-theme
  :config
  (global-display-theme-mode))

(use-package select-themes)

(use-package hl-line
  :ensure t
  :init (global-hl-line-mode))

#+END_SRC

** init-navigation
Gotta navigate around emacs more efficiently, and this is how.

#+BEGIN_SRC emacs-lisp
(use-package smex
  :config
  (progn
    (smex-initialize)
    (setq smex-save-file (concat dotemacs-cache-directory "smex-items"))
    (global-set-key (kbd "M-x") 'smex)
    (global-set-key (kbd "M-X") 'smex-major-mode-commands)
    ;; This is your old M-x.
    (global-set-key (kbd "C-c C-c M-x") 'execute-extended-command)))

;; https://github.com/krobertson/emacs.d/blob/master/packages.el
(use-package projectile
  :config
  (progn
    (projectile-global-mode 1))
  :init
  (progn
    (setq projectile-known-projects-file (concat dotemacs-cache-directory "projectile-bookmarks.eld"))
    (setq projectile-require-project-root nil)))

(use-package ace-jump-mode
  :config
  (progn
    (define-key global-map (kbd "C-c SPC") 'ace-jump-mode)))

;; ido mode configs
(use-package ido-vertical-mode
  :config
  (progn
    (setq ido-enable-flex-matching t)
    (setq ido-everywhere t)
    (ido-mode 1)
    (ido-vertical-mode t)))

;; https://github.com/bdd/.emacs.d/blob/master/packages.el
(use-package flx-ido
  :config
  (progn
    (flx-ido-mode 1)
    (setq flx-ido-threshhold 1000)
    (setq gc-cons-threshold 20000000)))

(use-package saveplace
  :config
  (progn
    (setq-default save-place t)
    (setq save-place-forget-unreadable-files nil)
    ;; Try to make emacsclient play nice with saveplace
    ;; http://www.emacswiki.org/emacs/EmacsClient#toc35
    (setq server-visit-hook (quote (save-place-find-file-hook)))
    ;; rename this save file....
    (setq save-place-file "~/.emacs.d/.cache/saved-places")))

#+END_SRC

** init-coding
Here we're going to make emacs a great coding environment.

#+BEGIN_SRC emacs-lisp
;; enable seeing of git diffs
;; got git-gutter working properly with use-package
;; https://github.com/hlissner/emacs.d/blob/master/init/init-git.el
(use-package git-gutter
  :diminish git-gutter-mode
  :config
  (progn
    (global-git-gutter-mode 1)))

(use-package git-timemachine)

(use-package magit
  :config
  (progn
    ;; http://whattheemacsd.com/setup-magit.el-01.html
    (defalias 'mgst 'magit-status)
    (defalias 'gst 'magit-status)
    (defalias 'st 'magit-status)
    (defadvice magit-status (around magit-fullscreen activate)
      (window-configuration-to-register :magit-fullscreen)
      ad-do-it
      (delete-other-windows))
    (defun magit-quit-session ()
      "Restores the previous window configuration and kills the magit buffer"
      (interactive)
      (kill-buffer)
      (jump-to-register :magit-fullscreen))))

(use-package web-mode
  :config
  (progn
    (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.gsp?\\'" . web-mode))))

(use-package js2-mode
  :config
  (progn
    (add-to-list 'auto-mode-alist '("\\.js?\\'" . js2-mode))))

;; https://github.com/jcf/emacs.d/blob/master/init-languages.org
(use-package css-mode
  :commands css-mode
  :init
  (setq css-indent-offset 2)
  :config
  (use-package rainbow-mode
    :pin gnu ;; uses gnu and not melpa for its repo
    :init
    (dolist (hook '(css-mode-hook html-mode-hook))
      (add-hook hook 'rainbow-mode))))

;; https://github.com/yasuyk/web-beautify
;; js-beautify installed by typing: npm -g install js-beautify
(use-package web-beautify)

(use-package groovy-mode
  :config
  (progn
    (autoload 'groovy-mode "groovy-mode" "Major mode for editing Groovy code." t)
    (add-to-list 'auto-mode-alist '("\.groovy$" . groovy-mode))
    (add-to-list 'auto-mode-alist '("\.gradle$" . groovy-mode))
    (add-to-list 'interpreter-mode-alist '("groovy" . groovy-mode))))

(use-package lua-mode
  :config
  (progn
    (add-to-list 'auto-mode-alist '("\\.lua?\\'" . js2-mode))))

(use-package vimrc-mode
  :config
  (progn
    (add-to-list 'auto-mode-alist '(".vim\\(rc\\)?$" . vimrc-mode))))

(use-package drag-stuff
  :config
  (progn
    (drag-stuff-global-mode t)))

;; http://stackoverflow.com/a/15310340/2741455
;; How to set defcustom variable
(use-package linum-relative
  :config
  (progn
    (setq linum-relative-format "%3s ")
    (setq linum-relative-current-symbol "")))

(cond ((executable-find "pt")
        (progn
          (use-package pt) ;; https://github.com/bling/pt.el
          (defalias 'my-search-util 'projectile-pt)))  ;; seems pretty fast (faster than ag? maybe...dunno), but it's written in Go!
      ((executable-find "ag")
        (progn
          (use-package ag) ;; https://github.com/Wilfred/ag.el
          (defalias 'my-search-util 'projectile-ag)))  ;; on the website, it said faster than ack
      ((executable-find "grep")
        (progn
          (defalias 'my-search-util 'projectile-grep))))

#+END_SRC

** init-evil
Lets add the awesome vim/modal editing keybindings. So much more fluid to edit with than emacs own.

#+BEGIN_SRC emacs-lisp
;; evil mode setup ;;;
(setq evil-want-C-u-scroll t)
(setq evil-want-C-w-in-emacs-state t)
(setq evil-default-cursor t)
(use-package evil
  :config
  (progn
    (evil-mode 1)
    (define-key evil-normal-state-map ";" 'evil-ex)
    (define-key evil-normal-state-map ":" 'smex)

    (evil-set-initial-state 'magit-status-mode 'emacs)
    (evil-set-initial-state 'magit-log-edit-mode 'emacs)

    (define-key evil-normal-state-map (kbd "C-<down>") 'drag-stuff-down)
    (define-key evil-normal-state-map (kbd "C-<up>") 'drag-stuff-up)

    (define-key evil-motion-state-map "j" 'evil-next-visual-line)
    (define-key evil-motion-state-map "k" 'evil-previous-visual-line)

    ;; https://stackoverflow.com/questions/20882935/how-to-move-between-visual-lines-and-move-past-newline-in-evil-mode
    ;; Make horizontal movement cross lines
    (setq-default evil-cross-lines t)

    (define-key evil-normal-state-map (kbd "C-w ]") 'evil-window-rotate-downwards)
    (define-key evil-normal-state-map (kbd "C-w [") 'evil-window-rotate-upwards)

    (define-key evil-normal-state-map (kbd "C-h")   'evil-window-left)
    (define-key evil-normal-state-map (kbd "C-j")   'evil-window-down)
    (define-key evil-normal-state-map (kbd "C-k")   'evil-window-up)
    (define-key evil-normal-state-map (kbd "C-l")   'evil-window-right)

    (evil-ex-define-cmd "Q"  'evil-quit)
    (evil-ex-define-cmd "Qa" 'evil-quit-all)
    (evil-ex-define-cmd "QA" 'evil-quit-all)

    ;; setup extra keybindings ;;
    ;; Bind DEL and = keys to scrolling up and down
    ;; https://stackoverflow.com/questions/8483182/evil-mode-best-practice
    (define-key evil-normal-state-map (kbd "DEL") (lambda ()
      (interactive)
      (previous-line 10)
      (evil-scroll-line-up 10)))

    (define-key evil-normal-state-map (kbd "=") (lambda ()
      (interactive)
      (next-line 10)
      (evil-scroll-line-down 10)))

    (use-package evil-leader
      :config
      (progn
        (global-evil-leader-mode t)
        (evil-leader/set-leader ",")
        (evil-leader/set-key
          "a" 'ace-jump-mode
          "b" 'ido-display-buffer
          "e" 'eval-region
          "f" 'my-search-util
          "l" 'linum-relative-toggle
          "k"  'kill-other-buffers
          "nf" 'neotree-find
          "nt" 'neotree-toggle
          "p" 'projectile-find-file
          "r" 'recentf-ido-find-file
          "t" 'select-themes
          "/" 'evilnc-comment-or-uncomment-lines
          "<down>" 'drag-stuff-down
          "<up>" 'drag-stuff-up)))

    (use-package neotree
      :config
      (progn
        ;; from https://github.com/andrewmcveigh/emacs.d
        ;; get keybindings to work better in neotree with evil
        (defun neotree-copy-file ()
          (interactive)
          (let* ((current-path (neo-buffer--get-filename-current-line))
                 (msg (format "Copy [%s] to: "
                              (neo-path--file-short-name current-path)))
                 (to-path (read-file-name msg (file-name-directory current-path))))
            (dired-copy-file current-path to-path t))
          (neo-buffer--refresh t))
        (define-minor-mode neotree-evil
          "Use NERDTree bindings on neotree."
          :lighter " NT"
          :keymap (progn
                    (evil-make-overriding-map neotree-mode-map 'normal t)
                    (evil-define-key 'normal neotree-mode-map
                      "C" 'neotree-change-root
                      "U" 'neotree-select-up-node
                      "r" 'neotree-refresh
                      "o" 'neotree-enter
                      (kbd "<return>") 'neotree-enter
                      "i" 'neotree-enter-horizontal-split
                      "s" 'neotree-enter-vertical-split
                      "n" 'evil-search-next
                      "N" 'evil-search-previous
                      "ma" 'neotree-create-node
                      "mc" 'neotree-copy-file
                      "md" 'neotree-delete-node
                      "mm" 'neotree-rename-node
                      "gg" 'evil-goto-first-line)
                    neotree-mode-map))))

    (use-package evil-nerd-commenter
      :commands (evilnc-comment-or-uncomment-lines)
      :config
      (progn
        (evilnc-default-hotkeys)))

    (use-package evil-matchit
      :config
      (progn
        (global-evil-matchit-mode 1)))

    (use-package evil-surround
      :config
      (progn
        (global-evil-surround-mode 1)))

    (use-package evil-visualstar
      :config
      (progn
        (global-evil-visualstar-mode)))

     (use-package evil-tabs
       :config
       (progn
         (global-evil-tabs-mode t)))

     (use-package evil-quickscope
       :config
       (progn
         (global-evil-quickscope-mode 1)))

    (use-package evil-numbers
      :config
      (progn
        (define-key evil-normal-state-map (kbd "C-<right>") 'evil-numbers/inc-at-pt)
        (define-key evil-normal-state-map (kbd "C-<left>") 'evil-numbers/dec-at-pt)))

    (use-package spaceline
      :config
      (progn
        (require 'spaceline-config)
        (spaceline-spacemacs-theme)))

))

#+END_SRC

** init-last-minute-touches
Here are some last minute touches. Run silent package upgrader and elpa-mirror towards the end of this init file, because by then use-package will have installed all packages of interest into the ~/.emacs.d/elpa directory. After all packages are there, then is the proper time to backup them.

#+BEGIN_SRC emacs-lisp

;; https://github.com/kiwanami/emacs-deferred
(deferred:$
  (deferred:wait (* 30 1000)) ;; 30 sec
  (deferred:nextc it
    (lambda ()
      (spu-package-upgrade)
      (message "[SPU] Emacs Silent Package Upgrader completed." )))
  (deferred:wait (* 120 1000)) ;; 120 sec
  (deferred:nextc it
    (lambda ()
      (elpamr-create-mirror-for-installed)
      (message "Elpa packages backed up to ~/.emacs.d/.backup-elpa/" ))))

#+END_SRC
